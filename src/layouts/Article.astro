---
import type {Post} from "@/content";
import DatePublished from "@/components/stats/DatePublished.astro";
import ReadTime from "@/components/stats/ReadTime.astro";
import Category from "@/components/stats/Category.astro";
import ViewsCounter from "@/components/stats/ViewsCounter.svelte";
import TableOfContent from "@/components/TableOfContent.astro";
import AsidePosts from "@/components/aside/AsidePosts.astro";
import PostComments from "@/components/PostComments.astro";
import {Img as Picture} from "astro-imagetools/components";

interface Props {
	post: Post;
	tags?: string[];
	categories?: string[];
	allPosts?: Post[];
}

const {post, allPosts = []} = Astro.props;

const similarPosts = allPosts
	.filter((p) => post.category === p.category && p.slug !== post.slug)
	.slice(0, 3);
---

<article
	role="article"
	data-pagefind-body
	class:list={[
		"mt-6",
		"relative isolate grid @container",
		"gap-y-8 px-4 lg:gap-x-4 lg:px-0",
		"grid-cols-[1fr,min(640px,100%),1fr]",
		"lg:grid-cols-[1fr,minmax(auto,224px),min(540px,100%),minmax(360px,224px),1fr]",
		"[&>*]:col-start-1 lg:[&>*]:col-start-2",
	]}
>
	<div class="col-span-3 lg:!col-end-5">
		<h1
			role="heading"
			data-weight="50"
			data-pagefind-meta="title"
			data-pagefind-sort="weight[data-weight]"
			class="font-title text-2xl font-light @xs:text-4xl @4xl:text-5xl"
		>
			{post.title}
		</h1>
	</div>

	<div class:list={["col-span-3 flex flex-wrap items-center gap-2"]}>
		<DatePublished published={post.published} />
		<ReadTime readtime={post.readtime} />
		<Category category={post.category} />
		<ViewsCounter slug={post.slug} client:idle />
	</div>

	<div class="col-span-3 lg:!col-end-5">
		<p class="prose max-w-full sm:prose-base">
			{post.description}
		</p>
	</div>

	<figure
		class:list={[
			"relative col-span-3 h-[33.3vw] w-full max-w-full lg:!col-end-5 lg:h-[400px]",
			"group/img overflow-clip rounded-box",
		]}
	>
		<div
			aria-hidden="true"
			class:list={[
				"absolute bottom-0 left-0 h-20 w-full",
				"rounded-box bg-gradient-to-t from-base-100 via-base-100/50 to-transparent",
				"z-10 transition-all duration-500 ease-in-out group-hover/img:h-0",
			]}
		>
		</div>

		<Picture
			alt={post.title}
			src={post.banner}
			width={1156}
			height={400}
			loading="eager"
			placeholder="blurred"
			breakpoints={[300, 480, 640, 1152]}
			format="avif"
			attributes={{
				img: {
					class: "absolute left-0 rounded-box transition duration-1000 ease-in-out hover:scale-110",
					"data-pagefind-meta": "image[src], image_alt[alt]",
				},
				style: `top: ${post.banner_y * 86}%;`,
			}}
		/>
	</figure>

	<div class="sticky top-2 col-span-3 space-y-4 lg:!col-start-4 lg:!col-end-5">
		<div class="sticky top-2 z-50 w-full space-y-8 bg-base-100">
			<TableOfContent headings={post.headings} isOpened />
		</div>

		<span class="hidden space-y-4 @6xl:block">
			{
				similarPosts.length !== 0 && (
					<AsidePosts posts={similarPosts} title="Related" label="Posts" />
				)
			}
		</span>
	</div>

	<div
		class:list={[
			"col-span-3  max-w-full @6xl:max-w-full lg:!col-end-4 lg:!row-start-5 lg:max-w-[620px] xl:max-w-full",
			"typograhy",
			"prose sm:prose-base",
			"prose-a:text-accent prose-a:underline",
			"prose-headings:font-title prose-headings:font-light prose-h1:font-bold prose-h2:font-semibold prose-h3:font-medium",
			"block-quote",
			"prose-blockquote:font-title prose-blockquote:font-light sm:prose-blockquote:text-lg",
			"prose-blockquote:px-4 prose-blockquote:py-2 prose-blockquote:font-title prose-blockquote:text-accent",
			"prose-blockquote:rounded-r-btn",
			"prose-blockquote:border-l-[8px] prose-blockquote:border-base-300 prose-blockquote:bg-accent/5",
			"hover:prose-blockquote:border-accent",
		]}
	>
		<slot>content not found</slot>
	</div>

	<div class="col-span-3 lg:!col-end-5">
		<PostComments />
	</div>
</article>
