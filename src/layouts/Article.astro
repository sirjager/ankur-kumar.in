---
import type {Post} from "@/content";
import {Picture} from "astro:assets";
import DatePublished from "@/components/stats/DatePublished.astro";
import ReadTime from "@/components/stats/ReadTime.astro";
import Category from "@/components/stats/Category.astro";
import ViewsCounter from "@/components/stats/ViewsCounter.svelte";
import TableOfContent from "@/components/TableOfContent.astro";
import AsideItems from "@/components/aside/AsideItems.astro";
import AsidePosts from "@/components/aside/AsidePosts.astro";
import PostComments from "@/components/PostComments.astro";

interface Props {
	post: Post;
	tags?: string[];
	categories?: string[];
	allPosts?: Post[];
}

const {post, categories, tags, allPosts = []} = Astro.props;

const similarPosts = allPosts
	.filter((p) => post.category === p.category && p.slug !== post.slug)
	.slice(0, 3);
---

<article
	role="article"
	data-pagefind-body
	class:list={[
		"relative mt-24 grid @container",
		"gap-y-8 px-4 lg:gap-x-4 lg:px-0",
		"grid-cols-[1fr,min(640px,100%),1fr]",
		"lg:grid-cols-[1fr,minmax(auto,224px),min(640px,100%),minmax(260px,224px),1fr]",
		"[&>*]:col-start-1 lg:[&>*]:col-start-2",
	]}
>
	<figure
		class:list={[
			"relative col-span-3 h-[33.3vw] w-full max-w-full lg:!col-end-5 lg:h-[400px]",
			"group/img overflow-clip rounded-box",
		]}
	>
		<div
			aria-hidden="true"
			class:list={[
				"absolute bottom-0 left-0 h-20 w-full",
				"bg-gradient-to-t from-base-100 via-base-100/50 to-transparent",
				"z-10 transition-all duration-500 ease-in-out group-hover/img:h-0",
			]}
		>
		</div>
		<Picture
			alt={post.title}
			quality="low"
			width={1200}
			height={400}
			src={post.banner}
			formats={["avif", "webp", "jpg"]}
			fallbackFormat="jpg"
			sizes={"(max-width: 360px) 240px, (max-width: 480px) 360px, (max-width: 768px) 480px, (max-width: 1024px) 768px, (max-width: 1280px) 1024px, (max-width: 1920px) 1280px"}
			style={{top: `-${post.banner_y * 86}%`}}
			class="absolute left-0 rounded-box transition duration-1000 ease-in-out hover:scale-110"
			data-pagefind-meta="image[src], image_alt[alt]"
		/>
	</figure>

	<div class="col-span-3 lg:!col-end-5">
		<h1
			role="heading"
			data-weight="50"
			data-pagefind-meta="title"
			data-pagefind-sort="weight[data-weight]"
			class="xs:text-2xl text-xl sm:text-3xl lg:text-4xl"
		>
			{post.title}
		</h1>
	</div>

	<div class:list={["col-span-3 row-start-3", "flex flex-wrap items-center gap-2 text-sm"]}>
		<DatePublished published={post.published} />
		<ReadTime readtime={post.readtime} />
		<Category category={post.category} />
		<ViewsCounter slug={post.slug} client:idle />
	</div>

	<div class="col-span-3 lg:!col-end-5">
		<p class="prose max-w-full">
			{post.description}
		</p>
	</div>

	<div class="col-span-3 row-start-5 space-y-4 lg:!col-start-4 lg:!col-end-5">
		<div class="sticky top-2 z-50 w-full space-y-8 bg-base-100">
			<TableOfContent headings={post.headings} />
		</div>

		<span class="hidden space-y-4 @6xl:block">
			<AsidePosts posts={similarPosts} title="Similar" label="Posts" />
			{categories && <AsideItems items={categories} title="Categories" />}
			{tags && <AsideItems items={tags} title="tags" />}
		</span>
	</div>

	<div
		class:list={["col-span-3 @6xl:max-w-full lg:!col-end-4 lg:!row-start-5", "prose sm:prose-base"]}
	>
		<slot>content not found</slot>
	</div>

	<div class="col-span-3 lg:!col-end-5">
		<PostComments />
	</div>
</article>
